# android-ssh-proxy

Android-приложение (Android 10+) для системного HTTP проксирования трафика через SSH локальный порт‑форвардинг + VpnService.setHttpProxy.

## Статус
⚠ Проект в активной разработке. Много недоработок, возможны крэши, утечки, несовместимости. Использовать только на свой риск.

## Что делает
- Генерирует SSH ключи (Ed25519 по умолчанию, также RSA/ECDSA).
- Показывает публичный ключ и готовые server setup инструкции (Privoxy / Tinyproxy, авто‑детект пакетного менеджера).
- Создает ограниченного пользователя на сервере (через предоставленный скрипт) для локального порт‑форвардинга.
- Устанавливает SSH соединение и локальный форвард: 127.0.0.1:8080 -> 127.0.0.1:8118 (HTTP proxy на сервере).
- Поднимает VpnService без маршрутов, задает системный HTTP proxy = 127.0.0.1:8080 (Android Q+).
- **Автоматическое переподключение с exponential backoff стратегией.**
- **Health-check мониторинг соединения через SSH keep-alive.**
- Логи подключения.
- Управление серверами (host / user / port / name).
- Инструкции + быстрый one‑liner скрипт развертывания.
- GitHub Actions workflow: сборка и релиз по git tag (vX.Y.Z).

## Ограничения и риски
| Тема | Деталь |
|------|--------|
| Проверка host key | Используется PromiscuousVerifier (нет реальной валидации) – MITM риск. |
| Только HTTP proxy | Не модифицирует HTTPS / TLS напрямую, зависит от системной прокси поддержки приложений. |
| Android < 10 | Не поддерживается (setHttpProxy недоступен). |
| Нет пер‑app исключений | Минималистичная конфигурация VPN без маршрутов, глобальный HTTP proxy. |
| ~~Без устойчивости~~ | ✅ Реализовано автоматическое переподключение с exponential backoff и health-check. |
| Локальное хранение ключей | Не зашифрованы (внутреннее хранилище приложений). |
| Скрипт сервера | Выполняется с root / sudo, нужно вручную ревью перед запуском. |

## Быстрый старт
1. Установить приложение (debug / release apk).
2. Первый запуск:
   - Генерируется ключ (или создайте вручную).
   - Скопируйте инструкции (Setup / Instructions) и выполните на сервере.
3. Убедиться что на сервере работает Privoxy или Tinyproxy на 127.0.0.1:8118.
4. Добавить сервер (только host, при необходимости раскрыть advanced).
5. Нажать Connect, выдать VPN разрешение.
6. Проверить в браузере что HTTP трафик идет через прокси (например, whatismyip).

## Функции автоматического переподключения

### Health-check мониторинг
- Периодическая проверка состояния SSH соединения (по умолчанию каждые 30 секунд)
- Отправка SSH keep-alive пакетов для проверки доступности
- Автоматическое обнаружение разрыва соединения

### Exponential Backoff стратегия
- Начальная задержка: 1 секунда
- Максимальная задержка: 5 минут
- Множитель: 2x (удвоение задержки после каждой неудачной попытки)
- Максимум попыток: 10 (настраивается)

### Настройки переподключения
В приложении доступны следующие настройки:
- Включение/отключение автоматического переподключения
- Интервал health-check (секунды)
- Максимальное количество попыток переподключения
- Начальная задержка backoff (секунды)
- Максимальная задержка backoff (секунды)

## Архитектура (упрощенно)
- SshProxyService: SSH, локальный ServerSocket, LocalPortForwarder, VPN builder.
- **ConnectionHealthMonitor**: Мониторинг состояния соединения и управление переподключением.
- UI: Fragments (Home, Servers, Keys, Instructions, Log, Setup flow, **Settings**).
- Data: Repositories (ServerRepository, KeyRepository (WIP), PreferencesManager).
- Логи: AppLog (LiveData).
- Ключи: SshKeyManager (legacy одиночный ключ) + новая система (мультиключ, WIP интеграция).

## Потоки
- UI: Main.
- SSH / порт‑форвардинг: Dispatchers.IO (корутины).
- Блокирующий listen() в отдельной job.
- Health-check: Периодическая корутина с таймаутом.

## Сборка (локально)
```bash
./gradlew assembleDebug
# или
./gradlew assembleRelease
```
Релизный подпись: добавить secrets и git tag вида v1.2.3 – GitHub Actions создаст релиз.

## GitHub Actions
Workflow: .github/workflows/release.yml
Триггер: push тега v*  
Артефакт: release APK + релиз.

## Возможные улучшения (TODO)
- [ ] Валидация host key (Known Hosts).
- [x] ~~Автопереподключение / watchdog.~~ ✅ Реализовано
- [ ] Настраиваемый локальный порт.
- [ ] UI статус активного сервера + ping / latency.
- [ ] Экспорт / импорт конфигурации.
- [ ] Шифрование приватных ключей (Android Keystore).
- [ ] Пер‑app proxy исключения (через addDisallowedApplication).
- [ ] Поддержка SOCKS5 на сервере как опция.
- [ ] Отдельный лог для ошибок SSH.

## Отладка
```bash
adb logcat -s SshProxyService AppLog ConnectionHealthMonitor
```

## Безопасность
Использование без проверки хоста снижает безопасность. Рекомендуется добавить known_hosts и отключить PromiscuousVerifier перед продакшен использованием.

## Отказ от ответственности
ПО предоставляется "как есть", без гарантий. Использование может нарушать политики сетей / провайдеров.

## Лицензия
(Apache-2.0)

---
Проект нестабилен. Сообщайте об issue и PR с улучшениями.
